<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Confira o Prato Elite</title>

  <!-- PWA (se j√° tiver manifest/service-worker, mant√©m) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <style>
    :root{
      --bg:#050816;
      --stroke:#1a2a4b;
      --text:#e8edf7;
      --muted:#98a2b3;
      --green:#19d18a;
      --green2:#10b981;
      --danger:#ff5c7a;
      --gold:#f5c542;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(25,209,138,.18), transparent 60%),
                  radial-gradient(800px 600px at 85% 15%, rgba(109,99,255,.18), transparent 55%),
                  radial-gradient(900px 800px at 50% 90%, rgba(16,185,129,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:430px; margin:0 auto; min-height:100vh; padding:18px 16px 92px;}
    .brand{display:flex; align-items:center; gap:12px; margin:10px 0 14px;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(145deg, rgba(109,99,255,.9), rgba(25,209,138,.75));
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      box-shadow: 0 0 18px rgba(109,99,255,.18);
    }
    .brand h1{
      margin:0; font-size:22px; letter-spacing:.6px; font-weight:900;
      background: linear-gradient(90deg, var(--green), #44f2c2);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-transform:uppercase;
      line-height:1.1;
    }
    .hint{margin-top:6px; font-size:12px; color:rgba(232,237,247,.65); line-height:1.35;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(26,42,75,.9);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    label{display:block; font-size:12px; letter-spacing:.6px; color:rgba(232,237,247,.7); margin:12px 0 8px; text-transform:uppercase;}
    input, select{
      width:100%; padding:14px 14px; border-radius:16px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(152,162,179,.75);}
    .row{display:flex; gap:10px;}
    .row>div{flex:1;}
    .btn{
      width:100%; border:0; border-radius:18px; padding:16px 14px;
      font-weight:900; letter-spacing:.7px; text-transform:uppercase;
      margin-top:14px;
      background: linear-gradient(90deg, rgba(25,209,138,.98), rgba(16,185,129,.88));
      color:#04110c;
      box-shadow: 0 18px 40px rgba(16,185,129,.16);
      cursor:pointer;
    }
    .btn.secondary{
      background: rgba(255,255,255,.03);
      color: var(--text);
      border:1px solid rgba(26,42,75,.9);
      box-shadow:none;
    }
    .status{margin-top:10px; font-size:13px; color:rgba(232,237,247,.9);}
    .pillRow{margin-top:10px;}
    .pill{
      display:inline-block; padding:8px 10px; border-radius:999px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
      font-weight:800; font-size:12px;
      margin:6px 6px 0 0;
    }
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px; border-radius:16px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
      margin-top:12px;
    }
    .check input{width:auto; margin-top:2px;}

    .danger{color: rgba(255,92,122,.95); font-weight:900;}

    .screen{display:none;}
    .screen.active{display:block;}

    .nav{
      position:fixed; left:0; right:0; bottom:0;
      background: rgba(3,8,20,.85);
      border-top:1px solid rgba(26,42,75,.9);
      backdrop-filter: blur(10px);
      padding:10px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .navInner{
      max-width:430px; margin:0 auto;
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      border-radius:22px; padding:10px 12px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(26,42,75,.9);
      overflow-x:auto;
    }
    .navBtn{
      min-width:84px;
      height:44px; border-radius:16px;
      border:0; background:transparent; color:rgba(232,237,247,.55);
      font-weight:900; cursor:pointer;
      white-space:nowrap;
    }
    .navBtn.active{
      color: var(--green);
      background: rgba(25,209,138,.10);
      border:1px solid rgba(25,209,138,.28);
    }

    /* Foto */
    .profileRow{
      display:flex; gap:12px; align-items:center; margin-top:10px;
      padding:12px; border-radius:18px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
    }
    .avatar{
      width:72px; height:72px; border-radius:18px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(255,255,255,.03);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
      font-weight:1000; color:rgba(232,237,247,.7);
      flex-shrink:0;
    }
    .avatar img{width:100%; height:100%; object-fit:cover;}
    .miniBtn{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(255,255,255,.03);
      color:var(--text); font-weight:900; cursor:pointer;
      width:100%;
    }
    .miniBtn.green{
      background: rgba(25,209,138,.10);
      border:1px solid rgba(25,209,138,.28);
      color: var(--green);
    }

    /* Esportes */
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:12px; border-radius:18px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
    }
    .chip{
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(255,255,255,.03);
      color: rgba(232,237,247,.8);
      font-weight:900; cursor:pointer; user-select:none;
    }
    .chip.active{
      background: rgba(25,209,138,.14);
      border:1px solid rgba(25,209,138,.30);
      color: var(--green);
    }

    /* Treino semana */
    .dayCard{
      margin-top:12px;
      padding:14px;
      border-radius:20px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
    }
    .dayTitle{
      font-weight:1000; letter-spacing:.6px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .exercise{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:10px 10px; border-radius:14px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(255,255,255,.03);
      margin-top:8px;
    }
    .exercise b{font-size:13px;}
    .ytBtn{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(25,209,138,.28);
      background: rgba(25,209,138,.10);
      color: var(--green);
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
    }

    /* Loja cards */
    .shopGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
    .shopItem{
      padding:14px; border-radius:20px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(3,8,20,.55);
    }
    .shopItem h3{margin:0 0 6px; font-size:14px; letter-spacing:.4px;}
    .shopItem p{margin:0 0 10px; font-size:12px; color:rgba(232,237,247,.7); line-height:1.3;}
    .shopItem button{
      width:100%;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid rgba(26,42,75,.9);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo">E</div>
      <div>
        <h1>Confira o Prato Elite</h1>
        <div class="hint">Cadastro + Dieta + Treino semanal + Loja + Parceiros (sem gastar).</div>
      </div>
    </div>

    <!-- CADASTRO -->
    <section id="viewCadastro" class="screen active">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:.6px;">CADASTRO & SA√öDE</div>
        <div class="hint">
          <span class="danger">Importante:</span> n√£o substitui orienta√ß√£o m√©dica.
        </div>

        <!-- Foto -->
        <label>Foto de perfil</label>
        <div class="profileRow">
          <div class="avatar" id="avatar">
            <span>FOTO</span>
          </div>
          <div style="flex:1;">
            <button class="miniBtn green" onclick="abrirEscolhaFoto()">Escolher/Tirar Foto</button>
            <button class="miniBtn" onclick="removerFoto()" style="margin-top:8px;">Remover foto</button>
            <div class="hint" style="margin-top:8px;">A foto fica salva no seu celular (por enquanto).</div>
          </div>
        </div>

        <!-- Inputs escondidos para foto -->
        <input id="fotoFile" type="file" accept="image/*" style="display:none;">
        <input id="fotoCamera" type="file" accept="image/*" capture="environment" style="display:none;">

        <label>Nome / Codinome</label>
        <input id="nome" placeholder="Ex: Jonatan / AGENTEX" />

        <div class="row">
          <div>
            <label>Idade</label>
            <input id="idade" type="number" placeholder="Ex: 28" />
          </div>
          <div>
            <label>Sexo</label>
            <select id="sexo">
              <option value="">Selecione</option>
              <option>Masculino</option>
              <option>Feminino</option>
              <option>Outro</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Peso (kg)</label>
            <input id="peso" type="number" step="0.1" placeholder="Ex: 78.5" />
          </div>
          <div>
            <label>Altura (cm)</label>
            <input id="altura" type="number" placeholder="Ex: 175" />
          </div>
        </div>

        <label>Objetivo</label>
        <select id="objetivo">
          <option value="">Selecione</option>
          <option>Emagrecer</option>
          <option>Ganhar massa</option>
          <option>Manter peso</option>
          <option>Melhorar sa√∫de</option>
        </select>

        <div class="row">
          <div>
            <label>N√≠vel</label>
            <select id="nivel">
              <option value="">Selecione</option>
              <option>Iniciante</option>
              <option>Intermedi√°rio</option>
              <option>Avan√ßado</option>
            </select>
          </div>
          <div>
            <label>Condi√ß√£o (se tiver)</label>
            <select id="condicao">
              <option value="">Selecione</option>
              <option>Nenhuma</option>
              <option>Diabetes</option>
              <option>Press√£o alta</option>
            </select>
          </div>
        </div>

        <label>Prefer√™ncia / Restri√ß√£o</label>
        <select id="restricao">
          <option value="">Selecione</option>
          <option>Nenhuma</option>
          <option>Vegetariano</option>
          <option>Vegano</option>
          <option>Intoler√¢ncia √† lactose</option>
          <option>Gl√∫ten</option>
        </select>

        <label>Esportes (pode marcar v√°rios)</label>
        <div class="chips" id="chipsEsportes"></div>
        <div class="hint">Voc√™ pode editar isso quando quiser: salva e pronto.</div>

        <div class="check">
          <input id="termo" type="checkbox" />
          <div>
            <div style="font-weight:900;">Eu entendo o termo</div>
            <div class="hint" style="margin:4px 0 0;">As sugest√µes s√£o informativas e n√£o substituem profissional.</div>
          </div>
        </div>

        <button class="btn" onclick="salvarPerfil()">Salvar / Atualizar</button>
        <button class="btn secondary" onclick="limparPerfil()">Limpar</button>

        <div id="statusCadastro" class="status"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:1000; letter-spacing:.6px;">SEU PERFIL</div>
        <div id="resumoPerfil" class="hint">Ainda n√£o salvo.</div>
        <div id="pills" class="pillRow"></div>
      </div>
    </section>

    <!-- DIETA -->
    <section id="viewDieta" class="screen">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:.6px;">DIETA (F√ÅCIL)</div>
        <div class="hint">Sugest√£o pr√°tica, baseada no seu objetivo + restri√ß√£o + condi√ß√£o.</div>
        <button class="btn" onclick="gerarDieta()">Gerar dieta</button>
        <button class="btn secondary" onclick="gerarDieta(true)">Nova dieta</button>
        <div id="outDieta" class="status"></div>
      </div>
    </section>

    <!-- TREINO -->
    <section id="viewTreino" class="screen">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:.6px;">TREINO DA SEMANA</div>
        <div class="hint">
          Gerado com base no n√≠vel + esportes que voc√™ marcou. Cada exerc√≠cio tem bot√£o do YouTube.
        </div>
        <button class="btn" onclick="gerarTreinoSemana()">Gerar treino da semana</button>
        <button class="btn secondary" onclick="limparTreino()">Limpar treino</button>
        <div id="outTreino" class="status"></div>
        <div id="treinoSemana"></div>
      </div>
    </section>

    <!-- LOJA (AFILIADOS) -->
    <section id="viewLoja" class="screen">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:.6px;">LOJA (AFILIADOS)</div>
        <div class="hint">Por enquanto links normais. Depois trocamos pelos links de afiliado.</div>

        <div class="shopGrid">
          <div class="shopItem">
            <h3>Suplementos</h3>
            <p>Whey, creatina, vitaminas.</p>
            <button onclick="abrirLink('https://www.gsuplementos.com.br')">Abrir</button>
          </div>
          <div class="shopItem">
            <h3>Roupas fitness</h3>
            <p>T√™nis, camisetas, shorts.</p>
            <button onclick="abrirLink('https://www.nike.com.br')">Abrir</button>
          </div>
          <div class="shopItem">
            <h3>Acess√≥rios</h3>
            <p>Luvas, garrafas, straps.</p>
            <button onclick="abrirLink('https://www.amazon.com.br')">Abrir</button>
          </div>
          <div class="shopItem">
            <h3>Marketplace</h3>
            <p>Pre√ßos variados (geral).</p>
            <button onclick="abrirLink('https://www.mercadolivre.com.br')">Abrir</button>
          </div>
        </div>

        <div class="hint" style="margin-top:12px;">
          Quando voc√™ criar conta de afiliado, a gente s√≥ troca as URLs aqui.
        </div>
      </div>
    </section>

    <!-- PARCEIROS (PREPARADO PRA LOCALIZA√á√ÉO) -->
    <section id="viewParceiros" class="screen">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:.6px;">PARCEIROS (PERTO DE VOC√ä)</div>
        <div class="hint">
          Em breve: academias e lojas parceiras na sua regi√£o. Quando ativarmos, o app vai pedir localiza√ß√£o
          s√≥ quando voc√™ clicar.
        </div>

        <button class="btn" onclick="simularParceiros()">Ver parceiros (simula√ß√£o)</button>
        <button class="btn secondary" onclick="explicarLocalizacao()">Como funciona a localiza√ß√£o?</button>

        <div id="outParceiros" class="status"></div>

        <div class="dayCard" style="margin-top:12px;">
          <div class="dayTitle">‚úÖ Preparado para o futuro</div>
          <div class="hint" style="margin-top:0;">
            Depois vamos ativar:
            <br>‚Ä¢ ‚ÄúPermitir localiza√ß√£o‚Äù (opcional)
            <br>‚Ä¢ Mostrar lista por dist√¢ncia
            <br>‚Ä¢ Bot√£o ‚ÄúAbrir no Maps‚Äù
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- NAV -->
  <div class="nav">
    <div class="navInner">
      <button class="navBtn active" data-view="cadastro">CADASTRO</button>
      <button class="navBtn" data-view="dieta">DIETA</button>
      <button class="navBtn" data-view="treino">TREINO</button>
      <button class="navBtn" data-view="loja">LOJA</button>
      <button class="navBtn" data-view="parceiros">PARCEIROS</button>
    </div>
  </div>

  <script>
    // PWA register (se j√° tiver service-worker.js)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    const KEY = "checkprato_perfil_v2_multi_esportes";
    const KEY_TREINO = "checkprato_treino_semana_v1";

    const ESPORTES = [
      "Muscula√ß√£o","Futebol","Corrida","Crossfit","Ciclismo","Nata√ß√£o",
      "Luta","Basquete","V√¥lei","Yoga","Pilates","Caminhada"
    ];

    const $ = (id) => document.getElementById(id);

    function getPerfil() {
      try { return JSON.parse(localStorage.getItem(KEY) || "null"); } catch { return null; }
    }
    function setPerfil(p) { localStorage.setItem(KEY, JSON.stringify(p)); }

    function getTreino() {
      try { return JSON.parse(localStorage.getItem(KEY_TREINO) || "null"); } catch { return null; }
    }
    function setTreino(t) { localStorage.setItem(KEY_TREINO, JSON.stringify(t)); }

    function switchView(view){
      ["viewCadastro","viewDieta","viewTreino","viewLoja","viewParceiros"].forEach(id => $(id).classList.remove("active"));
      if(view==="cadastro") $("viewCadastro").classList.add("active");
      if(view==="dieta") $("viewDieta").classList.add("active");
      if(view==="treino") $("viewTreino").classList.add("active");
      if(view==="loja") $("viewLoja").classList.add("active");
      if(view==="parceiros") $("viewParceiros").classList.add("active");

      document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
      document.querySelector(`.navBtn[data-view="${view}"]`)?.classList.add("active");
    }

    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=> switchView(btn.dataset.view));
    });

    // ====== FOTO (galeria + c√¢mera) ======
    function abrirEscolhaFoto(){
      // Pergunta simples: c√¢mera ou galeria
      const usarCamera = confirm("Quer tirar foto agora?\nOK = C√¢mera | Cancelar = Galeria");
      if(usarCamera) $("fotoCamera").click();
      else $("fotoFile").click();
    }
    window.abrirEscolhaFoto = abrirEscolhaFoto;

    $("fotoFile").addEventListener("change", (e)=> handleFoto(e.target.files?.[0]));
    $("fotoCamera").addEventListener("change", (e)=> handleFoto(e.target.files?.[0]));

    function removerFoto(){
      const p = getPerfil() || {};
      delete p.fotoDataUrl;
      setPerfil(p);
      renderFoto(null);
      $("statusCadastro").textContent = "üßπ Foto removida.";
    }
    window.removerFoto = removerFoto;

    async function handleFoto(file){
      if(!file) return;

      // Reduz imagem para n√£o pesar (m√°x 420px)
      const dataUrl = await compressImageToDataURL(file, 420, 0.82);

      const p = getPerfil() || {};
      p.fotoDataUrl = dataUrl;
      setPerfil(p);
      renderFoto(dataUrl);
      $("statusCadastro").textContent = "‚úÖ Foto salva no celular!";
    }

    function renderFoto(dataUrl){
      const avatar = $("avatar");
      avatar.innerHTML = "";
      if(!dataUrl){
        avatar.innerHTML = "<span>FOTO</span>";
        return;
      }
      const img = document.createElement("img");
      img.src = dataUrl;
      avatar.appendChild(img);
    }

    function compressImageToDataURL(file, maxSize, quality){
      return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = () => { img.src = reader.result; };
        reader.readAsDataURL(file);

        img.onload = () => {
          const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);

          const canvas = document.createElement("canvas");
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);

          // JPEG reduz bem o peso
          resolve(canvas.toDataURL("image/jpeg", quality));
        };
        img.onerror = () => resolve(null);
      });
    }

    // ====== ESPORTES MULTI ======
    let selectedSports = new Set();

    function buildSportsChips(){
      const box = $("chipsEsportes");
      box.innerHTML = "";
      ESPORTES.forEach((name)=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = name;
        chip.addEventListener("click", ()=>{
          if(selectedSports.has(name)) selectedSports.delete(name);
          else selectedSports.add(name);
          chip.classList.toggle("active", selectedSports.has(name));
        });
        box.appendChild(chip);
      });
    }

    function applySelectedSportsToUI(){
      const chips = [...document.querySelectorAll("#chipsEsportes .chip")];
      chips.forEach((c)=>{
        c.classList.toggle("active", selectedSports.has(c.textContent));
      });
    }

    // ====== SALVAR PERFIL ======
    function salvarPerfil(){
      if(!$("termo").checked){
        $("statusCadastro").textContent = "‚ö†Ô∏è Voc√™ precisa aceitar o termo para salvar.";
        return;
      }

      const old = getPerfil() || {};
      const perfil = {
        ...old,
        nome: $("nome").value.trim(),
        idade: Number($("idade").value),
        sexo: $("sexo").value,
        peso: Number($("peso").value),
        altura: Number($("altura").value),
        objetivo: $("objetivo").value,
        nivel: $("nivel").value,
        restricao: $("restricao").value,
        condicao: $("condicao").value,
        esportes: Array.from(selectedSports)
      };

      if(!perfil.nome || !perfil.idade || !perfil.peso || !perfil.altura || !perfil.objetivo){
        $("statusCadastro").textContent = "‚ö†Ô∏è Preencha: Nome, Idade, Peso, Altura e Objetivo.";
        return;
      }
      if(perfil.esportes.length === 0){
        $("statusCadastro").textContent = "‚ö†Ô∏è Marque pelo menos 1 esporte.";
        return;
      }

      setPerfil(perfil);
      $("statusCadastro").textContent = "‚úÖ Perfil salvo / atualizado!";
      renderPerfil();
    }
    window.salvarPerfil = salvarPerfil;

    function limparPerfil(){
      localStorage.removeItem(KEY);
      localStorage.removeItem(KEY_TREINO);
      selectedSports = new Set();
      buildSportsChips();
      applySelectedSportsToUI();
      $("statusCadastro").textContent = "üßπ Perfil apagado do celular.";
      $("resumoPerfil").textContent = "Ainda n√£o salvo.";
      $("pills").innerHTML = "";
      renderFoto(null);
      $("treinoSemana").innerHTML = "";
      $("outTreino").textContent = "";
    }
    window.limparPerfil = limparPerfil;

    function renderPerfil(){
      const p = getPerfil();
      if(!p) return;

      // Foto
      renderFoto(p.fotoDataUrl || null);

      const imc = (p.peso && p.altura) ? (p.peso / ((p.altura/100)**2)) : null;
      const imcTxt = imc ? `IMC ~ ${imc.toFixed(1)}` : "";

      $("resumoPerfil").textContent =
        `Ol√°, ${p.nome}. Objetivo: ${p.objetivo}. ${imcTxt}`.trim();

      const pills = [];
      pills.push(`${p.idade} anos`, `${p.peso} kg`, `${p.altura} cm`);
      if(p.nivel) pills.push(p.nivel);
      if(p.restricao) pills.push(p.restricao);
      if(p.condicao) pills.push(p.condicao);
      if(Array.isArray(p.esportes) && p.esportes.length) pills.push(`Esportes: ${p.esportes.join(", ")}`);

      $("pills").innerHTML = pills.filter(Boolean).map(t => `<span class="pill">${escapeHtml(t)}</span>`).join("");

      // preencher campos ao editar
      $("nome").value = p.nome || "";
      $("idade").value = p.idade || "";
      $("sexo").value = p.sexo || "";
      $("peso").value = p.peso || "";
      $("altura").value = p.altura || "";
      $("objetivo").value = p.objetivo || "";
      $("nivel").value = p.nivel || "";
      $("restricao").value = p.restricao || "";
      $("condicao").value = p.condicao || "";
      $("termo").checked = true;

      // esportes
      selectedSports = new Set(p.esportes || []);
      applySelectedSportsToUI();
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== DIETA F√ÅCIL ======
    function gerarDieta(nova=false){
      const p = getPerfil();
      if(!p){ $("outDieta").textContent = "‚ö†Ô∏è Fa√ßa o cadastro primeiro."; return; }

      // Base por objetivo (simples e pr√°tico)
      const dietas = {
        "Emagrecer": [
          "Caf√©: 2 ovos + 1 banana | Almo√ßo: frango grelhado + salada | Jantar: omelete + legumes",
          "Caf√©: iogurte + aveia | Almo√ßo: carne magra + arroz integral | Jantar: sopa de legumes",
          "Caf√©: tapioca + queijo | Almo√ßo: peixe/frango + legumes | Jantar: salada com prote√≠na"
        ],
        "Ganhar massa": [
          "Caf√©: ovos + p√£o | Almo√ßo: arroz + feij√£o + carne | Jantar: macarr√£o + frango",
          "Caf√©: vitamina (banana+aveia) | Almo√ßo: frango + batata doce | Jantar: carne + arroz",
          "Caf√©: iogurte + granola | Almo√ßo: peixe + arroz | Jantar: omelete + batata"
        ],
        "Manter peso": [
          "Caf√©: fruta + ovos | Almo√ßo: prato equilibrado | Jantar: prote√≠na + legumes",
          "Caf√©: iogurte + fruta | Almo√ßo: arroz+feij√£o+carne | Jantar: salada + frango",
          "Caf√©: p√£o + queijo | Almo√ßo: macarr√£o + carne | Jantar: sopa leve"
        ],
        "Melhorar sa√∫de": [
          "Caf√©: frutas + aveia | Almo√ßo: frango/peixe + salada | Jantar: legumes + ovos",
          "Caf√©: iogurte natural | Almo√ßo: arroz integral + feij√£o + salada | Jantar: sopa de legumes",
          "Caf√©: p√£o integral + ovos | Almo√ßo: prote√≠na magra + legumes | Jantar: salada refor√ßada"
        ]
      };

      let lista = dietas[p.objetivo] || dietas["Melhorar sa√∫de"];
      let escolha = lista[Math.floor(Math.random() * lista.length)];

      // Ajustes por restri√ß√£o
      if(p.restricao === "Vegetariano" || p.restricao === "Vegano"){
        escolha = escolha
          .replace(/frango|carne|peixe/gi, "gr√£o-de-bico/tofu")
          .replace(/ovos/gi, p.restricao === "Vegano" ? "tofu" : "ovos");
      }
      if(p.restricao === "Intoler√¢ncia √† lactose"){
        escolha = escolha.replace(/iogurte|queijo/gi, "iogurte/queijo sem lactose");
      }
      if(p.restricao === "Gl√∫ten"){
        escolha = escolha.replace(/p√£o|macarr√£o/gi, "op√ß√£o sem gl√∫ten");
      }

      // Avisos por condi√ß√£o
      let aviso = "";
      if(p.condicao === "Diabetes") aviso += " ‚ö†Ô∏è Aten√ß√£o com carboidratos e a√ß√∫car.";
      if(p.condicao === "Press√£o alta") aviso += " ‚ö†Ô∏è Reduzir s√≥dio (sal/embutidos).";

      $("outDieta").textContent = `${nova ? "üîÅ " : ""}${escolha}${aviso}`;
    }
    window.gerarDieta = gerarDieta;

    // ====== TREINO DA SEMANA ======
    function gerarTreinoSemana(){
      const p = getPerfil();
      if(!p){ $("outTreino").textContent = "‚ö†Ô∏è Fa√ßa o cadastro primeiro."; return; }

      const nivel = p.nivel || "Iniciante";
      const esportes = (p.esportes && p.esportes.length) ? p.esportes : ["Muscula√ß√£o"];

      // Escolhe ‚Äútema‚Äù principal pro treino (o primeiro esporte marcado)
      const tema = esportes[0];

      const plano = montarPlanoSemanal(tema, nivel);
      setTreino(plano);

      $("outTreino").textContent = `‚úÖ Treino da semana gerado: ${tema} (${nivel})`;
      renderTreinoSemana(plano);
    }
    window.gerarTreinoSemana = gerarTreinoSemana;

    function limparTreino(){
      localStorage.removeItem(KEY_TREINO);
      $("treinoSemana").innerHTML = "";
      $("outTreino").textContent = "üßπ Treino removido.";
    }
    window.limparTreino = limparTreino;

    function montarPlanoSemanal(tema, nivel){
      const dias = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];

      // Biblioteca simples por tema
      const LIB = {
        "Muscula√ß√£o": {
          "Iniciante": {
            A: ["Agachamento livre", "Supino reto", "Remada curvada", "Prancha"],
            B: ["Leg press", "Desenvolvimento ombro", "Puxada na barra", "Abdominal"],
            C: ["Levantamento terra (leve)", "Flex√£o", "Rosca b√≠ceps", "Tr√≠ceps banco"]
          },
          "Intermedi√°rio": {
            A: ["Agachamento", "Supino", "Remada", "Eleva√ß√£o lateral"],
            B: ["Terra", "Puxada", "Paralelas", "Panturrilha"],
            C: ["Avan√ßo", "Supino inclinado", "Remada unilateral", "Abd. infra"]
          },
          "Avan√ßado": {
            A: ["Agachamento pesado", "Supino pesado", "Barra fixa", "Eleva√ß√£o lateral"],
            B: ["Terra pesado", "Remada pesada", "Paralelas", "Panturrilha em p√©"],
            C: ["Avan√ßo com peso", "Supino inclinado", "Puxada aberta", "Core avan√ßado"]
          }
        },
        "Corrida": {
          "Iniciante": {
            A: ["Caminhada r√°pida 25min", "Trote leve 10min", "Alongamento"],
            B: ["Intervalado leve (1min trote/1min caminhada) 20min", "Alongamento"],
            C: ["Corrida leve 15min", "Educativos de corrida", "Alongamento"]
          },
          "Intermedi√°rio": {
            A: ["Corrida leve 30min", "Alongamento"],
            B: ["Tiros 8x (30s forte/60s leve)", "Alongamento"],
            C: ["Ritmo (tempo run) 20min", "Alongamento"]
          },
          "Avan√ßado": {
            A: ["Corrida leve 45min"],
            B: ["Tiros 12x (40s forte/60s leve)"],
            C: ["Ritmo 30min + educativos"]
          }
        },
        "Futebol": {
          "Iniciante": {
            A: ["Condu√ß√£o de bola (10min)", "Passe na parede (10min)", "Finaliza√ß√£o (10min)"],
            B: ["Agilidade (escada) 10min", "Arranque 6x", "Alongamento"],
            C: ["Dom√≠nio e controle 10min", "Passe curto 10min", "Finaliza√ß√£o 10min"]
          },
          "Intermedi√°rio": {
            A: ["Condu√ß√£o + drible 15min", "Finaliza√ß√£o 15min", "Core 10min"],
            B: ["Sprint 10x", "Agilidade 15min", "Mobilidade"],
            C: ["Passe longo 15min", "Finaliza√ß√£o 15min", "Resist√™ncia 20min"]
          },
          "Avan√ßado": {
            A: ["Dribles avan√ßados", "Finaliza√ß√£o intensa", "Core"],
            B: ["Sprint 15x", "Agilidade intensa", "Mobilidade"],
            C: ["Passe + finaliza√ß√£o", "Resist√™ncia forte", "Alongamento"]
          }
        },
        "Crossfit": {
          "Iniciante": {
            A: ["Burpee (leve)", "Agachamento", "Flex√£o (joelho)", "Prancha"],
            B: ["Kettlebell swing (leve)", "Abdominal", "Corrida leve 10min"],
            C: ["Thruster (leve)", "Remada el√°stico", "Saltos baixos"]
          },
          "Intermedi√°rio": {
            A: ["Burpee", "Thruster", "Pull-up assistido", "Core"],
            B: ["Swing", "Box jump", "Flex√£o", "Corrida 15min"],
            C: ["WOD 12‚Äì15min", "Mobilidade"]
          },
          "Avan√ßado": {
            A: ["WOD intenso 15‚Äì20min"],
            B: ["Levantamento ol√≠mpico (t√©cnica)", "Metcon"],
            C: ["Gin√°stica + WOD"]
          }
        },
        "Ciclismo": {
          "Iniciante": { A:["Pedal leve 30min"], B:["Subida leve 20min"], C:["Pedal 40min"] },
          "Intermedi√°rio": { A:["Pedal 60min"], B:["Intervalado 8x 1min forte"], C:["Subida 30min"] },
          "Avan√ßado": { A:["Long√£o 90min"], B:["Intervalado 12x 1min forte"], C:["Subida forte 40min"] }
        },
        "Nata√ß√£o": {
          "Iniciante": { A:["T√©cnica 20min"], B:["Nado leve 15min"], C:["T√©cnica + leve 25min"] },
          "Intermedi√°rio": { A:["S√©ries 8x50m"], B:["T√©cnica 30min"], C:["S√©ries 10x50m"] },
          "Avan√ßado": { A:["S√©ries 12x50m"], B:["S√©ries 8x100m"], C:["T√©cnica + ritmo"] }
        },
        "Yoga": {
          "Iniciante": { A:["Yoga iniciante 20min"], B:["Mobilidade 15min"], C:["Yoga leve 25min"] },
          "Intermedi√°rio": { A:["Yoga 35min"], B:["Mobilidade 25min"], C:["Yoga 40min"] },
          "Avan√ßado": { A:["Yoga 50min"], B:["Power yoga 40min"], C:["Yoga 60min"] }
        },
        "Pilates": {
          "Iniciante": { A:["Pilates iniciante 20min"], B:["Core leve 15min"], C:["Pilates 25min"] },
          "Intermedi√°rio": { A:["Pilates 35min"], B:["Core 25min"], C:["Pilates 40min"] },
          "Avan√ßado": { A:["Pilates 50min"], B:["Core intenso 35min"], C:["Pilates 60min"] }
        },
        "Caminhada": {
          "Iniciante": { A:["Caminhada 25min"], B:["Caminhada 30min"], C:["Caminhada 35min"] },
          "Intermedi√°rio": { A:["Caminhada r√°pida 40min"], B:["Subida 30min"], C:["Caminhada 45min"] },
          "Avan√ßado": { A:["Caminhada r√°pida 60min"], B:["Subida forte 40min"], C:["Caminhada 70min"] }
        },
        "Luta": {
          "Iniciante": { A:["Base e guarda 15min", "Sombra 10min"], B:["Alongamento + mobilidade"], C:["Golpes b√°sicos 20min"] },
          "Intermedi√°rio": { A:["Sombra 20min", "Condicionamento 15min"], B:["T√©cnica 30min"], C:["Sparring leve"] },
          "Avan√ßado": { A:["Sombra intensa", "Condicionamento"], B:["T√©cnica avan√ßada"], C:["Sparring"] }
        },
        "Basquete": {
          "Iniciante": { A:["Drible 10min", "Arremesso 10min"], B:["Agilidade 10min"], C:["Passe 10min", "Arremesso 10min"] },
          "Intermedi√°rio": { A:["Arremesso 20min", "Drible 15min"], B:["Agilidade 15min"], C:["Resist√™ncia 20min"] },
          "Avan√ßado": { A:["Arremesso intenso", "Drible avan√ßado"], B:["Agilidade intensa"], C:["Jogo/condicionamento"] }
        },
        "V√¥lei": {
          "Iniciante": { A:["Manchete 15min", "Saque 10min"], B:["Agilidade 10min"], C:["Toque 15min", "Saque 10min"] },
          "Intermedi√°rio": { A:["Saque 20min", "Manchete 15min"], B:["Pliometria leve"], C:["Ataque 15min"] },
          "Avan√ßado": { A:["Saque/ataque intenso"], B:["Pliometria"], C:["Treino t√©cnico forte"] }
        },
        "Outro": {
          "Iniciante": { A:["Treino leve 20min"], B:["Mobilidade 15min"], C:["Cardio leve 20min"] },
          "Intermedi√°rio": { A:["Treino 35min"], B:["Cardio 25min"], C:["For√ßa 30min"] },
          "Avan√ßado": { A:["Treino 50min"], B:["Cardio 40min"], C:["For√ßa 45min"] }
        }
      };

      const pack = (LIB[tema] && LIB[tema][nivel]) ? LIB[tema][nivel] : (LIB["Muscula√ß√£o"][nivel] || LIB["Muscula√ß√£o"]["Iniciante"]);

      // Monta rotina: ABC + descanso + cardio leve + descanso
      const A = pack.A || ["Treino A"];
      const B = pack.B || ["Treino B"];
      const C = pack.C || ["Treino C"];
      const descanso = ["Descanso / Alongamento 15min"];
      const cardio = tema === "Muscula√ß√£o"
        ? ["Caminhada 25min", "Alongamento"]
        : ["Mobilidade 15min"];

      const rotina = [
        { dia: dias[0], bloco:"A", itens:A },
        { dia: dias[1], bloco:"B", itens:B },
        { dia: dias[2], bloco:"C", itens:C },
        { dia: dias[3], bloco:"DESC", itens:descanso },
        { dia: dias[4], bloco:"A", itens:A },
        { dia: dias[5], bloco:"CARD", itens:cardio },
        { dia: dias[6], bloco:"DESC", itens:descanso }
      ];

      return { tema, nivel, rotina, createdAt: Date.now() };
    }

    function renderTreinoSemana(plano){
      const box = $("treinoSemana");
      box.innerHTML = "";

      if(!plano || !plano.rotina){
        box.innerHTML = "";
        return;
      }

      plano.rotina.forEach((d)=>{
        const day = document.createElement("div");
        day.className = "dayCard";

        const title = document.createElement("div");
        title.className = "dayTitle";
        title.innerHTML = `<span>${d.dia}</span><span style="opacity:.75;font-weight:1000;">${d.bloco}</span>`;
        day.appendChild(title);

        d.itens.forEach((ex)=>{
          const row = document.createElement("div");
          row.className = "exercise";

          const left = document.createElement("div");
          left.innerHTML = `<b>${escapeHtml(ex)}</b><div style="font-size:12px;opacity:.7;">Toque para ver no YouTube</div>`;

          const btn = document.createElement("button");
          btn.className = "ytBtn";
          btn.textContent = "YouTube";
          btn.addEventListener("click", ()=>{
            const q = encodeURIComponent(ex + " como fazer");
            window.open(`https://www.youtube.com/results?search_query=${q}`, "_blank");
          });

          row.appendChild(left);
          row.appendChild(btn);
          day.appendChild(row);
        });

        box.appendChild(day);
      });
    }

    // ====== LINKS ======
    function abrirLink(url){
      window.open(url, "_blank");
    }
    window.abrirLink = abrirLink;

    // ====== PARCEIROS (SIMULA√á√ÉO + PREPARO) ======
    function simularParceiros(){
      $("outParceiros").innerHTML =
        "üìç Exemplo (simula√ß√£o):<br>‚Ä¢ Academia Elite Center (2,1 km)<br>‚Ä¢ Loja Fit Suplementos (3,4 km)<br><br>Em breve isso ser√° real com localiza√ß√£o (opcional).";
    }
    window.simularParceiros = simularParceiros;

    function explicarLocalizacao(){
      $("outParceiros").innerHTML =
        "üîí A localiza√ß√£o ser√° usada s√≥ quando voc√™ clicar.<br>Voc√™ pode negar se quiser.<br>Objetivo: mostrar parceiros perto, nada de rastrear voc√™.";
    }
    window.explicarLocalizacao = explicarLocalizacao;

    // ====== INIT ======
    function init(){
      buildSportsChips();

      // Carrega perfil salvo
      const p = getPerfil();
      if(p){
        selectedSports = new Set(p.esportes || []);
        applySelectedSportsToUI();
        renderPerfil();
      }else{
        // default: nenhum selecionado
        applySelectedSportsToUI();
      }

      // Carrega treino salvo
      const t = getTreino();
      if(t){
        renderTreinoSemana(t);
        $("outTreino").textContent = `‚úÖ Treino salvo: ${t.tema} (${t.nivel})`;
      }
    }

    // Salvar treino quando renderizar (ap√≥s gerar)
    const originalGerar = gerarTreinoSemana;
    // (J√° salva dentro do gerarTreinoSemana via setTreino)
    // mas para garantir, salvamos quando gerar
    function setTreinoAndRender(plano){
      setTreino(plano);
      renderTreinoSemana(plano);
    }

    // Ajuste: salvar treino dentro do gerar
    const oldGerarTreino = window.gerarTreinoSemana;
    // j√° est√° ok pelo setTreino(plano) e renderTreinoSemana(plano)

    // Hook: sempre que gerar treino, salvar e render (j√° feito)

    // Sobrescreve setTreino no gerarTreinoSemana via setTreino(plano)
    // ok

    init();
  </script>
</body>
</html>
